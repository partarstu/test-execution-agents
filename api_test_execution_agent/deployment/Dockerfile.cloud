#
# Copyright Â© 2025 Taras Paruta (partarstu@gmail.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Use Eclipse Temurin JRE as base image (lightweight)
FROM eclipse-temurin:25-jre-alpine

ARG APP_DIR=/app
ARG APP_LOG_DIR=${APP_DIR}/log
ARG SOURCE_JAR_PATH=api_test_execution_agent/target/api-test-execution-agent-1.0.0-SNAPSHOT.jar
ARG DESTINATION_JAR_PATH=${APP_DIR}/app.jar

# Install curl for health checks and ca-certificates for HTTPS
RUN apk add --no-cache curl ca-certificates

# Create application directory and log directory
RUN mkdir -p ${APP_DIR} ${APP_LOG_DIR}

# Create a non-root user for running the application
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copy the application JAR
COPY ${SOURCE_JAR_PATH} ${DESTINATION_JAR_PATH}

# Set permissions
RUN chown -R appuser:appgroup ${APP_DIR}

# Switch to non-root user
USER appuser

# Set working directory
WORKDIR ${APP_DIR}

# Environment variables
ENV APP_JAR_PATH=${DESTINATION_JAR_PATH}
ENV LOG_DIR=${APP_LOG_DIR}
ENV DEPLOYMENT_ENV="cloud"

# Cloud Run expects the application to listen on the specified port
# The agent uses AGENT_HOST and PORT environment variables from AgentConfig
ENV AGENT_HOST="0.0.0.0"
ENV PORT="8005"

# Expose the port
EXPOSE 8005

# Run the application with cloud logging configuration
# Using exec form to ensure proper signal handling for graceful shutdown
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
