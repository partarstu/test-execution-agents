#
# Copyright Â© 2025 Taras Paruta (partarstu@gmail.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

steps:
  # ============================================
  # Stage 1: Build all Maven modules
  # ============================================
  - name: 'maven:3.9.11-eclipse-temurin-25'
    id: 'maven-build'
    dir: '/workspace'
    args: [ 'mvn', 'clean', 'install', '-DskipTests', '-P', 'linux' ]

  # ============================================
  # Stage 2: UI Test Execution Agent (VM-based)
  # ============================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build-ui-base-image'
    dir: '/workspace'
    args: [ 'build', '-t', 'ui-testing-agent-base:latest', '-f', 'ui_test_execution_agent/deployment/Dockerfile.base', '.' ]
    waitFor: [ 'maven-build' ]

  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build-ui-agent'
    dir: '/workspace'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/$_UI_AGENT_SERVICE_NAME:$_IMAGE_TAG', '-f', 'ui_test_execution_agent/deployment/cloud/Dockerfile', '.' ]
    waitFor: [ 'docker-build-ui-base-image' ]

  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push-ui-agent'
    args: [ 'push', 'gcr.io/$PROJECT_ID/$_UI_AGENT_SERVICE_NAME:$_IMAGE_TAG' ]
    waitFor: [ 'docker-build-ui-agent' ]

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-ui-agent-chmod'
    entrypoint: 'bash'
    args: [ '-c', 'chmod +x ui_test_execution_agent/deployment/cloud/deploy_vm.sh' ]
    dir: '/workspace'
    waitFor: [ 'docker-push-ui-agent' ]

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-ui-agent-vm'
    entrypoint: 'bash'
    args: [ '-c', 'ui_test_execution_agent/deployment/cloud/deploy_vm.sh' ]
    dir: '/workspace'
    env:
      - 'SERVICE_NAME=$_UI_AGENT_SERVICE_NAME'
      - 'IMAGE_TAG=$_IMAGE_TAG'
    waitFor: [ 'deploy-ui-agent-chmod' ]

  # ============================================
  # Stage 3: API Test Execution Agent (Cloud Run)
  # ============================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build-api-agent'
    dir: '/workspace'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/$_API_AGENT_SERVICE_NAME:$_IMAGE_TAG', '-f', 'api_test_execution_agent/deployment/Dockerfile.cloud', '.' ]
    waitFor: [ 'maven-build' ]

  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push-api-agent'
    args: [ 'push', 'gcr.io/$PROJECT_ID/$_API_AGENT_SERVICE_NAME:$_IMAGE_TAG' ]
    waitFor: [ 'docker-build-api-agent' ]

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-api-agent-cloud-run'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '$_API_AGENT_SERVICE_NAME'
      - '--image=gcr.io/$PROJECT_ID/$_API_AGENT_SERVICE_NAME:$_IMAGE_TAG'
      - '--region=$_REGION'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--port=8005'
      - '--memory=$_API_AGENT_MEMORY'
      - '--cpu=$_API_AGENT_CPU'
      - '--timeout=300'
      - '--concurrency=2'
      - '--min-instances=0'
      - '--max-instances=1'
      - '--set-env-vars=DEPLOYMENT_ENV=cloud'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,GROQ_API_KEY=GROQ_API_KEY:latest'
    waitFor: [ 'docker-push-api-agent' ]

substitutions:
  _UI_AGENT_SERVICE_NAME: 'ui-test-execution-agent'
  _API_AGENT_SERVICE_NAME: 'api-test-execution-agent'
  _IMAGE_TAG: 'latest'
  _REGION: 'europe-west1'
  _API_AGENT_MEMORY: '1Gi'
  _API_AGENT_CPU: '1'

options:
  logging: CLOUD_LOGGING_ONLY